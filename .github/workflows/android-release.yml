name: Android Release Build

on:
  push:
    branches:
      - main
      - release/*
    tags:
      - 'android-v*'
  pull_request:
    branches:
      - main
    paths:
      - 'android/**'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (apk or aab)'
        required: true
        default: 'aab'
        type: choice
        options:
          - apk
          - aab

jobs:
  build:
    name: Build Android Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
          
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
            
      - name: Grant execute permission for gradlew
        working-directory: android
        run: chmod +x gradlew
        
      - name: Decode Keystore
        if: github.event_name != 'pull_request'
        working-directory: android
        env:
          ENCODED_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -n "$ENCODED_KEYSTORE" ]; then
            echo "$ENCODED_KEYSTORE" | base64 -d > shona-release-key.jks
          fi
          
      - name: Run Lint
        working-directory: android
        run: ./gradlew lintRelease
        
      - name: Run Tests
        working-directory: android
        run: ./gradlew testReleaseUnitTest
        
      - name: Build Release AAB
        if: github.event.inputs.build_type != 'apk'
        working-directory: android
        env:
          SHONA_RELEASE_STORE_FILE: shona-release-key.jks
          SHONA_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          SHONA_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          SHONA_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: ./gradlew bundleRelease
        
      - name: Build Release APK
        if: github.event.inputs.build_type == 'apk'
        working-directory: android
        env:
          SHONA_RELEASE_STORE_FILE: shona-release-key.jks
          SHONA_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          SHONA_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          SHONA_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: ./gradlew assembleRelease
        
      - name: Upload AAB Artifact
        if: github.event.inputs.build_type != 'apk'
        uses: actions/upload-artifact@v4
        with:
          name: shona-learn-release-aab
          path: android/app/build/outputs/bundle/release/*.aab
          retention-days: 30
          
      - name: Upload APK Artifact
        if: github.event.inputs.build_type == 'apk'
        uses: actions/upload-artifact@v4
        with:
          name: shona-learn-release-apk
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 30
          
      - name: Upload to Google Play (AAB only)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/android-v') && github.event.inputs.build_type != 'apk'
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.shonalearn.android
          releaseFiles: android/app/build/outputs/bundle/release/*.aab
          track: production
          status: draft
          whatsNewDirectory: android/metadata/
          
  notification:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"Android build ${{ needs.build.result }}\"}" \
            $SLACK_WEBHOOK_URL
