// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  password      String
  name          String
  age           Int?           // User's age for content filtering
  ageGroup      String?        // "children", "teens", "adults"
  parentEmail   String?        // For children accounts
  parentConsent Boolean      @default(false) // Parental consent for children
  xp            Int            @default(0)
  streak        Int            @default(0)
  level         Int            @default(1)
  hearts        Int            @default(5)
  lastActive    DateTime       @default(now())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  progress      UserProgress[]
  questProgress QuestProgress[]
  socialConnections SocialConnection[] @relation("UserConnections")
  connectedTo   SocialConnection[] @relation("ConnectedToUser")
  learningGoals LearningGoal[]
  intrinsicMotivation IntrinsicMotivation?
  flashcards    Flashcard[]
  srsProgress   SRSProgress[]
  notificationPreferences NotificationPreference?
  completedLessons CompletedLesson[]
  achievements   Achievement[]
  UserStats      UserStats[]
  Progress       Progress[]
  ContentFilter  ContentFilter[]
  
  @@map("users")
}

model Lesson {
  id            String         @id @default(cuid())
  title         String
  description   String
  category      String
  orderIndex    Int
  level         String
  ageRange      String?        // "5-12", "13-17", "18+"
  ageRestriction String?      // "childrenOnly", "teensAndAdults", "adultsOnly"
  kidfriendly   Boolean        @default(false)
  visualAids    Boolean        @default(false)
  interactiveElements Boolean @default(false)
  xpReward      Int            @default(10)
  estimatedDuration Int
  content       String?        // JSON content
  vocabulary    String?        // JSON vocabulary
  culturalNotes String?        // JSON cultural notes
  questId       String?
  quest         Quest?         @relation(fields: [questId], references: [id])
  exercises     Exercise[]
  userProgress  UserProgress[]
  learningObjectives String?  // JSON string of learning objectives
  discoveryElements String?   // JSON string of exploration prompts
  flashcards    Flashcard[]
  completedLessons CompletedLesson[]
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@map("lessons")
}

model Quest {
  id            String         @id @default(cuid())
  title         String
  description   String
  storyNarrative String        // The quest narrative/story
  category      String
  ageRange      String?        // "5-12", "13-17", "18+"
  mascot        String?        // JSON mascot info
  difficulty    String
  estimatedDuration Int
  totalXP       Int
  milestones    String?        // JSON milestones
  rewards       String?        // JSON rewards
  orderIndex    Int
  requiredLevel Int            @default(1)
  lessons       Lesson[]
  questProgress QuestProgress[]
  collaborativeElements String? // JSON string of social learning features
  intrinsicRewards String?    // JSON string of intrinsic motivation elements
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@map("quests")
}

model Exercise {
  id            String   @id @default(cuid())
  lessonId      String
  type          String   // multiple_choice, translation, matching, exploration, collaboration
  title         String
  question      String
  ageRange      String?    // "5-12", "13-17", "18+"
  kidfriendly   Boolean      @default(false)
  gameType      String?      // "drag_drop", "coloring", "music_interactive", etc.
  difficulty    String
  points        Int      @default(5)
  correctAnswer String
  options       String?    // JSON options
  intrinsicFeedback String? // JSON feedback
  activities    String?    // JSON activities
  shonaPhrase   String?
  englishPhrase String?
  audioText     String?     // Text for TTS
  discoveryHint String?     // Hint for exploration-based learning
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  lesson        Lesson   @relation(fields: [lessonId], references: [id])
  
  @@map("exercises")
}

model UserProgress {
  id          String   @id @default(cuid())
  userId      String
  lessonId    String
  completed   Boolean  @default(false)
  score       Int      @default(0)
  completedAt DateTime @default(now())
  intrinsicSatisfaction Int? // 1-10 scale of intrinsic satisfaction
  user        User     @relation(fields: [userId], references: [id])
  lesson      Lesson   @relation(fields: [lessonId], references: [id])
  
  @@unique([userId, lessonId])
}

model QuestProgress {
  id          String   @id @default(cuid())
  userId      String
  questId     String
  completed   Boolean  @default(false)
  completedAt DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
  quest       Quest    @relation(fields: [questId], references: [id])
  
  @@unique([userId, questId])
}

model SocialConnection {
  id          String   @id @default(cuid())
  userId      String
  connectedUserId String
  connectionType String // study_buddy, mentor, mentee, peer
  createdAt   DateTime @default(now())
  user        User     @relation("UserConnections", fields: [userId], references: [id])
  connectedTo User     @relation("ConnectedToUser", fields: [connectedUserId], references: [id])
  
  @@unique([userId, connectedUserId])
}

model LearningGoal {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String
  targetDate  DateTime?
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
}

model IntrinsicMotivation {
  id          String   @id @default(cuid())
  userId      String   @unique
  autonomy    Int      @default(5) // 1-10 scale
  competence  Int      @default(5) // 1-10 scale
  relatedness Int      @default(5) // 1-10 scale
  lastUpdated DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
}

// Flashcard System Models
model Flashcard {
  id            String   @id @default(cuid())
  userId        String
  lessonId      String?
  shonaText     String
  englishText   String
  audioText     String?
  pronunciation String?  // IPA or simplified pronunciation
  difficulty    Float    @default(0.5) // 0.0 to 1.0
  tags          String? // JSON string of tags
  context       String?  // Example sentence or context
  createdAt     DateTime @default(now())
  lastReviewed  DateTime?
  user          User     @relation(fields: [userId], references: [id])
  lesson        Lesson?  @relation(fields: [lessonId], references: [id])
  srsProgress   SRSProgress[]
  
  @@unique([userId, shonaText])
}

model SRSProgress {
  id            String   @id @default(cuid())
  userId        String
  flashcardId   String
  easeFactor    Float    @default(2.5) // Supermemo algorithm ease factor
  interval      Int      @default(1)   // Days until next review
  repetitions   Int      @default(0)   // Number of successful reviews
  lastReview    DateTime @default(now())
  nextReview    DateTime @default(now())
  quality       Int      @default(3)   // Last review quality (0-5)
  totalReviews  Int      @default(0)
  correctStreak Int      @default(0)
  wrongStreak   Int      @default(0)
  averageTime   Float    @default(0.0) // Average response time in seconds
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id])
  flashcard     Flashcard @relation(fields: [flashcardId], references: [id])
  
  @@unique([userId, flashcardId])
}

model NotificationPreference {
  id                String   @id @default(cuid())
  userId            String   @unique
  enabledDays       String? // JSON string of days ["monday", "tuesday", etc.]
  startTime         String   @default("09:00") // "HH:MM" format
  endTime           String   @default("21:00") // "HH:MM" format
  maxDailyNotifications Int  @default(5)
  intervalMinutes   Int      @default(240)    // 4 hours default
  enabledTypes      String? // JSON string ["review", "new_cards", "streak_reminder"]
  timezone          String   @default("UTC")
  deviceTokens      String? // JSON string of device tokens for push notifications
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id])
}

model NotificationLog {
  id          String   @id @default(cuid())
  userId      String?
  type        String   // "review", "new_cards", "streak_reminder", "achievement"
  title       String
  body        String
  data        String?  // JSON string for additional data
  sentAt      DateTime @default(now())
  opened      Boolean  @default(false)
  openedAt    DateTime?
  deviceToken String?
  success     Boolean  @default(true)
  errorMessage String?
}

model CompletedLesson {
  id          String   @id @default(cuid())
  userId      String
  lessonId    String
  score       Int?
  completedAt DateTime @default(now())
  user        User       @relation(fields: [userId], references: [id])
  lesson      Lesson     @relation(fields: [lessonId], references: [id])
  
  @@unique([userId, lessonId])
  @@map("completed_lessons")
}

model Progress {
  id            String   @id @default(cuid())
  userId        String
  totalXP       Int      @default(0)
  currentStreak Int      @default(0)
  maxStreak     Int      @default(0)
  level         Int      @default(1)
  hearts        Int      @default(5)
  completedLessons Int    @default(0)
  childrenLessonsCompleted Int @default(0)
  adultLessonsCompleted    Int @default(0)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  user          User         @relation(fields: [userId], references: [id])
  
  @@unique([userId])
  @@map("progress")
}

model Achievement {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String
  icon        String
  unlockedAt  DateTime @default(now())
  user        User       @relation(fields: [userId], references: [id])
  
  @@map("achievements")
}

model UserStats {
  id                 String   @id @default(cuid())
  userId             String
  totalTimeSpent     Int      @default(0) // in minutes
  averageSessionTime Int      @default(0)
  lessonsPerWeek     Int      @default(0)
  favoriteCategory   String?
  kidActivitiesCompleted Int    @default(0)
  parentEngagement       Int    @default(0) // For tracking parent involvement
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user             User         @relation(fields: [userId], references: [id])
  
  @@unique([userId])
  @@map("user_stats")
}

model ContentFilter {
  id          String   @id @default(cuid())
  userId      String
  filterType  String   // "age", "content", "custom"
  filterValue String   // JSON filter criteria
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User       @relation(fields: [userId], references: [id])
  
  @@map("content_filters")
}
